<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>Gerenciador de Dados da Planilha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Estilos personalizados para a fonte e o corpo */
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc; /* Cor de fundo mais clara */
        color: #374151; /* Cor de texto padrão */
      }
      .container-main {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        padding: 1.5rem;
      }
      @media (min-width: 1024px) {
        .container-main {
          flex-direction: row;
        }
      }

      /* MELHORIAS VISUAIS PARA FILTROS E TABELA */
      .card {
        background-color: #ffffff;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        border: 1px solid #e2e8f0;
      }
      
      .filtro-card {
        padding: 1rem;
        margin-bottom: 0.5rem;
      }
      .form-group label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #4b5563;
        margin-bottom: 0.25rem;
      }
      .form-group input,
      .form-group select {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        color: #374151;
        font-size: 1rem;
        border-radius: 0.5rem;
        padding: 0.5rem 0.75rem;
        margin-bottom: 0.25rem;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .form-group input:focus,
      .form-group select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px #bfdbfe;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
      }
      .btn-primary {
        background-color: #2563eb;
        color: #fff;
        border: none;
      }
      .btn-primary:hover {
        background-color: #1d4ed8;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .btn-secondary {
        background: #e5e7eb;
        color: #4b5563;
        border: 1px solid #d1d5db;
      }
      .btn-secondary:hover {
        background: #d1d5db;
        color: #374151;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      .btn-danger {
        background-color: #ef4444;
        color: #fff;
        border: none;
      }
      .btn-danger:hover {
        background-color: #dc2626;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      /* TABELA */
      .table-container {
        overflow-x: auto;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
      }
      .tabela-dados {
        width: 100%;
        border-collapse: collapse;
      }
      .tabela-dados thead th {
        position: sticky;
        top: 0;
        background: #f1f5f9;
        color: #64748b;
        z-index: 2;
        font-size: 0.875rem;
        font-weight: 700;
        text-transform: uppercase;
        border-bottom: 2px solid #e2e8f0;
      }
      .tabela-dados tbody tr {
        transition: background-color 0.2s;
      }
      .tabela-dados tbody tr:nth-child(even) {
        background: #f8fafc;
      }
      .tabela-dados tbody tr:hover {
        background: #eef2ff;
      }
      .tabela-dados td {
        font-size: 0.95rem;
        color: #4b5563;
        border-bottom: 1px solid #f3f4f6;
      }
      .tabela-dados th, .tabela-dados td {
        padding: 0.75rem 1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .tabela-dados th.sortable {
        cursor: pointer;
        position: relative;
      }
      .tabela-dados th.sorted-asc::after {
        content: ' ▲';
        font-size: 0.8em;
      }
      .tabela-dados th.sorted-desc::after {
        content: ' ▼';
        font-size: 0.8em;
      }
      .message-box {
        padding: 0.75rem;
        border-radius: 0.5rem;
        font-weight: 500;
      }
      .message-box.success {
        background-color: #d1fae5;
        color: #065f46;
      }
      .message-box.error {
        background-color: #fee2e2;
        color: #991b1b;
      }
      .loading-spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        width: 1.25rem;
        height: 1.25rem;
        animation: spin 1s linear infinite;
        margin-left: 0.5rem;
        display: inline-block;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Estilos para o Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
      }
      .modal-content {
        background-color: #fff;
        border-radius: 0.75rem;
        padding: 2rem;
        max-width: 900px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      }
      .modal-close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 2rem;
        color: #9ca3af;
        cursor: pointer;
      }
    </style>
  </head>
  <body class="bg-gray-50 p-4 sm:p-6 md:p-8">
    
    <div class="text-right text-gray-600 text-sm mb-4">
      Usuário logado: <span id="userEmailDisplay" class="font-semibold text-gray-800">Carregando...</span>
    </div>

    <h1 class="text-3xl font-extrabold text-center mb-6 text-gray-900">Gerenciador de Dados da Planilha</h1>

    <div class="text-center mb-8">
      <button id="openAddRecordModalBtn" class="btn btn-primary text-xl px-8 py-3">
        + Adicionar Novo Registro
      </button>
    </div>

    <div class="container-main">
      <div class="w-full lg:w-1/4 card h-fit sticky top-4">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Filtrar Dados</h2>
        <form id="filterForm" class="space-y-4">
          <div class="grid grid-cols-1 gap-4">
            <div class="form-group">
              <label for="filterSistema">Sistema:</label>
              <select id="filterSistema" name="sistema" class="w-full">
                <option value="">Todos</option>
                <option value="PAE 3.0">PAE 3.0</option>
                <option value="PAE 4.0">PAE 4.0</option>
                <option value="SAJ/ATTUS">SAJ/ATTUS</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filterNumPaejSaj">Núm.PAE/SAJ:</label>
              <input type="text" id="filterNumPaejSaj" name="numPaejSaj" class="w-full">
            </div>
            <div class="form-group">
              <label for="filterInteressado">Interessado:</label>
              <input type="text" id="filterInteressado" name="interessado" class="w-full">
            </div>
            <div class="form-group">
              <label for="filterSituacao">Situação:</label>
              <select id="filterSituacao" name="situacao" class="w-full">
                <option value="">Todos</option>
                <option value="CONFORME">CONFORME</option>
                <option value="CONFORME PARCIAL">CONFORME PARCIAL</option>
                <option value="INCONFORME">INCONFORME</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filterAssimetria">Assimetria:</label>
              <select id="filterAssimetria" name="assimetria" class="w-full">
                <option value="">Todos</option>
                <option value="DESACORDO LEGAL">DESACORDO LEGAL</option>
                <option value="FALTA DE DOCUMENTO">FALTA DE DOCUMENTO</option>
                <option value="PRAZO">PRAZO</option>
                <option value="ESCLARECIMENTO">ESCLARECIMENTO</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filterUgOrigem">UG Origem:</label>
              <input type="text" id="filterUgOrigem" name="ugOrigem" class="w-full">
            </div>
            <div class="form-group">
              <label for="filterAssunto">Assunto:</label>
              <select id="filterAssunto" name="assunto" class="w-full">
                <option value="">Todos</option>
                </select>
            </div>
            <div class="form-group">
              <label for="filterSubAssunto">Sub Assunto:</label>
              <select id="filterSubAssunto" name="subAssunto" class="w-full" disabled>
                <option value="">Todos</option>
                </select>
            </div>
            <div class="form-group">
              <label for="filterAciResponsavel">ACI Responsável:</label>
              <input type="text" id="filterAciResponsavel" name="aciResponsavel" class="w-full">
            </div>
            <div class="form-group">
              <label for="filterDestino">Destino:</label>
              <input type="text" id="filterDestino" name="destino" class="w-full">
            </div>
            <div class="form-group flex gap-2">
              <div class="flex-1">
                <label for="filterSaidaInicio">Saída (de):</label>
                <input type="date" id="filterSaidaInicio" name="saidaInicio" class="w-full">
              </div>
              <div class="flex-1">
                <label for="filterSaidaFim">Saída (até):</label>
                <input type="date" id="filterSaidaFim" name="saidaFim" class="w-full">
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-2 mt-6">
            <button type="button" id="applyFiltersBtn" class="btn btn-primary w-full">
              Aplicar Filtros
              <span id="filterSpinner" class="loading-spinner hidden"></span>
            </button>
            <button type="button" id="clearFiltersBtn" class="btn btn-secondary w-full">
              Limpar Filtros
            </button>
          </div>
        </form>
      </div>

      <div class="w-full lg:w-3/4">
        <div class="card p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Dados Existentes na Planilha</h2>
            <button id="refreshDataBtn" class="btn btn-secondary">
              Atualizar Dados
              <span id="refreshSpinner" class="loading-spinner hidden"></span>
            </button>
          </div>
          
          <div id="dataContainer" class="table-container" style="max-height: 65vh; overflow-y: auto;">
            <table class="tabela-dados">
              <thead>
                <tr>
                  <th class="px-4 py-2 sortable" data-field="sistema">Sistema</th>
                  <th class="px-4 py-2 sortable" data-field="numPaejSaj">Núm.PAE/SAJ</th>
                  <th class="px-4 py-2 sortable" data-field="interessado">Interessado</th>
                  <th class="px-4 py-2 sortable" data-field="entrada">Entrada</th>
                  <th class="px-4 py-2 sortable" data-field="situacao">Situação</th>
                  <th class="px-4 py-2 sortable" data-field="assimetria">Assimetria</th>
                  <th class="px-4 py-2">Observação</th>
                  <th class="px-4 py-2 sortable" data-field="ugOrigem">UG Origem</th>
                  <th class="px-4 py-2 sortable" data-field="assunto">Assunto</th>
                  <th class="px-4 py-2 sortable" data-field="subAssunto">Sub Assunto</th>
                  <th class="px-4 py-2 sortable" data-field="aciResponsavel">ACI Responsável</th>
                  <th class="px-4 py-2 sortable" data-field="destino">Destino</th>
                  <th class="px-4 py-2 sortable" data-field="saida">Saída</th>
                  <th class="px-4 py-2">Ações</th>
                </tr>
              </thead>
              <tbody id="dataTableBody" class="divide-y divide-gray-200">
                <tr>
                  <td colspan="15" class="text-center py-4 text-gray-500">Nenhum dado carregado.</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="flex justify-between items-center mt-4">
            <button id="prevPageBtn" class="btn btn-secondary text-sm px-4 py-2" disabled>Anterior</button>
            <span id="pageInfo" class="text-gray-700 font-semibold text-sm">Página 1 de 1</span>
            <button id="nextPageBtn" class="btn btn-secondary text-sm px-4 py-2" disabled>Próximo</button>
          </div>
          <div id="readMessage" class="message-box hidden mt-4"></div>
        </div>
      </div>
    </div>

    <div id="recordModal" class="modal-overlay hidden">
      <div class="modal-content">
        <button id="closeModalBtn" class="modal-close-btn">&times;</button>
        <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-800">Adicionar Novo Registro</h2>
        <form id="recordFormModal" class="space-y-4">
          <input type="hidden" id="recordRowIndex" name="rowIndex">

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="form-group">
              <label for="modalSistema">Sistema:</label>
              <select id="modalSistema" name="sistema" class="w-full">
                <option value="">Selecione</option>
                <option value="PAE 3.0">PAE 3.0</option>
                <option value="PAE 4.0">PAE 4.0</option>
                <option value="SAJ/ATTUS">SAJ/ATTUS</option>
              </select>
            </div>
            <div class="form-group">
              <label for="modalNumPaejSaj">Núm.PAE/SAJ:</label>
              <input type="text" id="modalNumPaejSaj" name="numPaejSaj" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalInteressado">Interessado:</label>
              <input type="text" id="modalInteressado" name="interessado" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalEntrada">Entrada:</label>
              <input type="date" id="modalEntrada" name="entrada" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalSituacao">Situação:</label>
              <select id="modalSituacao" name="situacao" class="w-full">
                <option value="">Selecione</option>
                <option value="CONFORME">CONFORME</option>
                <option value="CONFORME PARCIAL">CONFORME PARCIAL</option>
                <option value="INCONFORME">INCONFORME</option>
              </select>
            </div>
            <div class="form-group">
              <label for="modalAssimetria">Assimetria:</label>
              <select id="modalAssimetria" name="assimetria" class="w-full">
                <option value="">Selecione</option>
                <option value="DESACORDO LEGAL">DESACORDO LEGAL</option>
                <option value="FALTA DE DOCUMENTO">FALTA DE DOCUMENTO</option>
                <option value="PRAZO">PRAZO</option>
                <option value="ESCLARECIMENTO">ESCLARECIMENTO</option>
              </select>
            </div>
            <div class="form-group">
              <label for="modalObservacao">Observação:</label>
              <textarea id="modalObservacao" name="observacao" rows="2" class="w-full"></textarea>
            </div>
            <div class="form-group">
              <label for="modalUgOrigem">UG Origem:</label>
              <input type="text" id="modalUgOrigem" name="ugOrigem" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalAssunto">Assunto:</label>
              <select id="modalAssunto" name="assunto" class="w-full">
                <option value="">Selecione</option>
                </select>
            </div>
            <div class="form-group">
              <label for="modalSubAssunto">Sub Assunto:</label>
              <select id="modalSubAssunto" name="subAssunto" class="w-full" disabled>
                <option value="">Selecione</option>
                </select>
            </div>
            <div class="form-group">
              <label for="modalAciResponsavel">ACI Responsável:</label>
              <input type="text" id="modalAciResponsavel" name="aciResponsavel" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalDestino">Destino:</label>
              <input type="text" id="modalDestino" name="destino" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalSaida">Saída:</label>
              <input type="date" id="modalSaida" name="saida" class="w-full">
            </div>
          </div>
          <button type="submit" id="modalSubmitBtn" class="btn btn-primary w-full sm:w-auto mt-4">
            Gravar Registro
            <span id="modalLoadingSpinner" class="loading-spinner hidden"></span>
          </button>
          <div id="modalResponseMessage" class="message-box hidden"></div>
        </form>
      </div>
    </div>
    <script>
      // Variáveis de Paginação
      let currentPage = 1;
      const pageSize = 20; // Defina o número de registros por página
      let totalRecords = 0;
      let totalPages = 1;
      let currentFilters = {}; // Objeto para armazenar os filtros ativos

      // Variáveis do Dashboard
      let allDataForDashboard = []; // Para armazenar todos os dados brutos para o dashboard
      let currentTableData = []; // Para armazenar os dados da tabela atual para edição

      // Referências aos elementos do modal
      const recordModal = document.getElementById('recordModal');
      const openAddRecordModalBtn = document.getElementById('openAddRecordModalBtn');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const recordFormModal = document.getElementById('recordFormModal');
      const modalLoadingSpinner = document.getElementById('modalLoadingSpinner');
      const modalResponseMessage = document.getElementById('modalResponseMessage');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubmitBtn = document.getElementById('modalSubmitBtn');

      // Referência ao campo oculto para o índice da linha
      const recordRowIndex = document.getElementById('recordRowIndex');

      // Referências aos campos Sistema e Num. PAEJ S.A.J. (para máscara)
      const modalSistemaSelect = document.getElementById('modalSistema');
      const modalNumPaejSajInput = document.getElementById('modalNumPaejSaj');
      const sistemaSelectFilter = document.getElementById('filterSistema');

      // Referências para os campos Situação e Assimetria no modal
      const modalSituacaoSelect = document.getElementById('modalSituacao');
      const modalAssimetriaSelect = document.getElementById('modalAssimetria');

      // Novas referências para os campos Assunto e Sub Assunto (modal e filtro)
      const modalAssuntoSelect = document.getElementById('modalAssunto');
      const modalSubAssuntoSelect = document.getElementById('modalSubAssunto');
      const filterAssuntoSelect = document.getElementById('filterAssunto');
      const filterSubAssuntoSelect = document.getElementById('filterSubAssunto');

      // Referências para os novos campos ACI Responsável, Destino e Saída (modal e filtro)
      const modalAciResponsavelInput = document.getElementById('modalAciResponsavel');
      const modalDestinoInput = document.getElementById('modalDestino');
      const modalSaidaInput = document.getElementById('modalSaida'); // Input de data já existia, mas referenciando explicitamente

      const filterAciResponsavelInput = document.getElementById('filterAciResponsavel');
      const filterDestinoInput = document.getElementById('filterDestino');
      const filterSaidaInput = document.getElementById('filterSaida');

      // Referência para exibir o e-mail do usuário
      const userEmailDisplay = document.getElementById('userEmailDisplay');


      let assuntoSubAssuntoMap = {}; // Variável para armazenar o mapeamento Assunto -> Sub Assuntos

      // Nomes dos campos do formulário para fácil iteração (total de 14 campos agora)
      const formFields = [
        'sistema', 'numPaejSaj', 'interessado', 'entrada', 'situacao',
        'assimetria', 'observacao', 'ugOrigem', 'assunto', 'subAssunto',
        'aciResponsavel', 'destino', 'saida'
      ];

      // Mapeamento dos nomes dos campos do formulário para os índices das colunas na planilha (base 0 para JS)
      // ATENÇÃO: ESTE MAPEAMENTO DEVE CORRESPONDER À ORDEM DAS COLUNAS NA SUA PLANILHA GOOGLE
      const sheetColumnIndexes = {
        sistema: 0,
        numPaejSaj: 1,
        interessado: 2,
        entrada: 3,
        situacao: 4,
        assimetria: 5,
        observacao: 6,
        ugOrigem: 7,
        assunto: 8,
        subAssunto: 9,
        aciResponsavel: 10,
        destino: 11,
        saida: 12
      };


      // Função para exibir mensagens de status
      function showMessage(elementId, message, type) {
        const messageBox = document.getElementById(elementId);
        messageBox.textContent = message;
        messageBox.className = `message-box ${type}`; // Adiciona classes de estilo dinamicamente
        messageBox.classList.remove('hidden');
      }

      // Função para esconder mensagens de status
      function hideMessage(elementId) {
        const messageBox = document.getElementById(elementId);
        if (messageBox) {
          messageBox.classList.add('hidden');
        }
      }

      // Função para mostrar ou esconder o spinner de carregamento
      function toggleSpinner(spinnerId, show) {
        const spinner = document.getElementById(spinnerId);
        if (spinner) {
          spinner.classList.toggle('hidden', !show);
        }
      }

      // Atualiza os controles de paginação (botões e texto)
      function updatePaginationControls() {
        document.getElementById('pageInfo').textContent = `Página ${currentPage} de ${totalPages}`;
        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalRecords === 0;
      }

      // Funções para abrir e fechar o modal (reutilizado para adicionar/editar)
      function openRecordModal(mode, rowIndex = -1, rowData = null) {
        recordModal.classList.remove('hidden');
        hideMessage('modalResponseMessage'); // Esconde mensagens anteriores

        if (mode === 'add') {
          recordFormModal.reset();
          modalTitle.textContent = 'Adicionar Novo Registro';
          modalSubmitBtn.textContent = 'Gravar Registro';
          recordRowIndex.value = '';
          modalNumPaejSajInput.value = '';
          modalNumPaejSajInput.placeholder = 'Selecione um Sistema para a máscara';
          modalSistemaSelect.value = '';
          updateAssimetriaFieldState();
          populateAssuntoDropdown(modalAssuntoSelect, 'Selecione');
          populateSubAssuntoDropdown(modalSubAssuntoSelect, [], 'Selecione', true);
        } else if (mode === 'edit' && rowData) {
          modalTitle.textContent = 'Editar Registro';
          modalSubmitBtn.textContent = 'Atualizar Registro';
          recordRowIndex.value = rowIndex;
          // Preencher o formulário com os dados da linha
          formFields.forEach(field => {
            let inputElement = document.getElementById('modal' + field.charAt(0).toUpperCase() + field.slice(1));
            if (field === 'numPaejSaj') inputElement = document.getElementById('modalNumPaejSaj');
            if (field === 'aciResponsavel') inputElement = document.getElementById('modalAciResponsavel');
            if (inputElement) {
              const value = rowData[sheetColumnIndexes[field]];
              if (inputElement.type === 'date') {
                if (value && typeof value === 'string' && value.match(/^[0-9]{4}-[0-9]{2}-[0-9]{2}T/)) {
                  inputElement.value = value.split('T')[0];
                } else {
                  // Se o valor é uma data do Apps Script (Date object), formatar para YYYY-MM-DD
                  if (value instanceof Date && !isNaN(value)) {
                    inputElement.value = value.toISOString().split('T')[0];
                  } else {
                    inputElement.value = '';
                  }
                }
              } else if (inputElement.tagName === 'SELECT') {
                // Para selects, defina o valor diretamente
                inputElement.value = value;
                // Se for Assunto, dispare a atualização do Sub Assunto
                if (field === 'assunto') {
                  populateAssuntoDropdown(modalAssuntoSelect, 'Selecione');
                  modalAssuntoSelect.value = value;
                  updateSubAssuntoDropdown(modalAssuntoSelect, modalSubAssuntoSelect);
                  modalSubAssuntoSelect.value = rowData[sheetColumnIndexes['subAssunto']];
                }
                // Se for Situação, dispare a atualização da Assimetria
                if (field === 'situacao') {
                  updateAssimetriaFieldState();
                }
                // Se for Sistema, dispare a atualização da máscara do PAEJ SAJ
                if (field === 'sistema') {
                  updatePaejMask();
                }
              } else {
                inputElement.value = value;
              }
            }
          });
          // Se o sistema já estiver selecionado na edição, aplica a máscara
          if (modalSistemaSelect.value) {
            updatePaejMask();
            applyMask(modalNumPaejSajInput, masks[modalSistemaSelect.value]);
          }
        }
        recordModal.classList.remove('hidden');
      }

      function closeRecordModal() {
        recordModal.classList.add('hidden');
      }

      // Lógica de Máscara de Entrada para Num. PAEJ S.A.J.
      const masks = {
        'PAE 3.0': '2025/00000000',
        'PAE 4.0': 'E-2025/00000000',
        'SAJ/ATTUS': '2020.01.00000000000'
      };

      function applyMask(inputElement, mask) {
        if (!inputElement || !mask) return;

        inputElement.placeholder = mask; // Exibe a máscara como placeholder
        let current = inputElement.value;
        let formatted = '';
        let maskCharIndex = 0;
        let valueCharIndex = 0;

        while (maskCharIndex < mask.length && valueCharIndex < current.length) {
          if (mask[maskCharIndex] === '0') { // Caractere de preenchimento (número)
            if (/\d/.test(current[valueCharIndex])) {
              formatted += current[valueCharIndex];
              valueCharIndex++;
            }
            maskCharIndex++;
          } else { // Caractere literal da máscara
            formatted += mask[maskCharIndex];
            if (mask[maskCharIndex] === current[valueCharIndex]) {
              valueCharIndex++; // Consome o caractere da entrada se corresponder à máscara
            }
            maskCharIndex++;
          }
        }
        inputElement.value = formatted;
      }

      function updatePaejMask() {
        const selectedSystem = modalSistemaSelect.value;
        const mask = masks[selectedSystem];
        if (mask) {
          modalNumPaejSajInput.placeholder = mask;
        } else {
          modalNumPaejSajInput.value = '';
          modalNumPaejSajInput.placeholder = 'Selecione um Sistema para a máscara';
        }
      }

      // Lógica de dependência entre Situação e Assimetria
      function updateAssimetriaFieldState() {
        const situacaoValue = modalSituacaoSelect.value;
        if (situacaoValue === 'CONFORME') {
          modalAssimetriaSelect.value = ''; // Limpa o valor
          modalAssimetriaSelect.disabled = true; // Desabilita o campo
          modalAssimetriaSelect.classList.add('bg-gray-200'); // Adiciona estilo visual de desabilitado
        } else {
          modalAssimetriaSelect.disabled = false; // Habilita o campo
          modalAssimetriaSelect.classList.remove('bg-gray-200'); // Remove estilo visual de desabilitado
        }
      }

      // Lógica de dependência entre Assunto e Sub Assunto
      function populateAssuntoDropdown(dropdownElement, defaultOptionText = 'Selecione') {
        dropdownElement.innerHTML = ''; // Limpa opções existentes
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = defaultOptionText;
        dropdownElement.appendChild(defaultOption);

        const assuntos = Object.keys(assuntoSubAssuntoMap).sort(); // Obtém e ordena os assuntos
        assuntos.forEach(assunto => {
          const option = document.createElement('option');
          option.value = assunto;
          option.textContent = assunto;
          dropdownElement.appendChild(option);
        });
      }

      function populateSubAssuntoDropdown(dropdownElement, subAssuntos, defaultOptionText = 'Selecione', disable = false) {
        dropdownElement.innerHTML = ''; // Limpa opções existentes
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = defaultOptionText;
        dropdownElement.appendChild(defaultOption);

        subAssuntos.sort().forEach(subAssunto => { // Adiciona e ordena sub assuntos
          const option = document.createElement('option');
          option.value = subAssunto;
          option.textContent = subAssunto;
          dropdownElement.appendChild(option);
        });

        dropdownElement.disabled = disable;
        dropdownElement.classList.toggle('bg-gray-200', disable);
      }

      function updateSubAssuntoDropdown(assuntoSelectElement, subAssuntoSelectElement) {
        const selectedAssunto = assuntoSelectElement.value;
        const subAssuntos = assuntoSubAssuntoMap[selectedAssunto] || [];
        
        if (selectedAssunto === '') {
            populateSubAssuntoDropdown(subAssuntoSelectElement, [], 'Selecione', true); // Limpa e desabilita
        } else {
            populateSubAssuntoDropdown(subAssuntoSelectElement, subAssuntos, 'Selecione', false); // Habilita
        }
      }


      // --- EVENT LISTENERS ---

      // Sistema e Num. PAEJ S.A.J. (Modal)
      modalSistemaSelect.addEventListener('change', updatePaejMask);
      modalNumPaejSajInput.addEventListener('input', function() {
        const selectedSystem = modalSistemaSelect.value;
        const mask = masks[selectedSystem];
        if (mask) {
          applyMask(this, mask);
        }
      });

      // Situação e Assimetria (Modal)
      modalSituacaoSelect.addEventListener('change', updateAssimetriaFieldState);

      // Assunto e Sub Assunto (Modal)
      modalAssuntoSelect.addEventListener('change', function() {
        updateSubAssuntoDropdown(modalAssuntoSelect, modalSubAssuntoSelect);
      });

      // Assunto e Sub Assunto (Filtro)
      filterAssuntoSelect.addEventListener('change', function() {
        updateSubAssuntoDropdown(filterAssuntoSelect, filterSubAssuntoSelect);
      });


      // Lida com o envio do formulário dentro do modal para gravar/atualizar dados
      recordFormModal.addEventListener('submit', function(e) {
        e.preventDefault(); // Impede o envio padrão do formulário
        hideMessage('modalResponseMessage'); // Esconde mensagens anteriores
        toggleSpinner('modalLoadingSpinner', true); // Mostra o spinner

        const formData = new FormData(this);
        const data = {};
        for (let [key, value] of formData.entries()) {
          data[key] = value;
        }

        const rowIndexToEdit = recordRowIndex.value;

        if (rowIndexToEdit) { // Modo de Edição
          google.script.run
            .withSuccessHandler(function(response) {
              toggleSpinner('modalLoadingSpinner', false); // Esconde o spinner
              if (response.sucesso) {
                showMessage('modalResponseMessage', response.mensagem, 'success');
                setTimeout(() => {
                  closeRecordModal();
                  lerDadosExistentes(); // Recarrega a tabela atualizada
                }, 1500);
              } else {
                showMessage('modalResponseMessage', response.mensagem, 'error');
              }
            })
            .withFailureHandler(function(error) {
              toggleSpinner('modalLoadingSpinner', false); // Esconde o spinner
              showSpecificError(error);
            })
            .atualizarDadosWeb(rowIndexToEdit, data);
        } else { // Modo de Adição
          google.script.run
            .withSuccessHandler(function(response) {
              toggleSpinner('modalLoadingSpinner', false); // Esconde o spinner
              if (response.sucesso) {
                showMessage('modalResponseMessage', response.mensagem, 'success');
                setTimeout(() => {
                  closeRecordModal();
                  currentPage = 1; // Volta para a primeira página para ver o novo registro
                  lerDadosExistentes();
                }, 1500);
              } else {
                showMessage('modalResponseMessage', response.mensagem, 'error');
              }
            })
            .withFailureHandler(function(error) {
              toggleSpinner('modalLoadingSpinner', false); // Esconde o spinner
              showSpecificError(error);
            })
            .gravarDadosWeb(data);
        }
      });

      // Lida com o clique no botão de atualizar dados
      document.getElementById('refreshDataBtn').addEventListener('click', function() {
        currentPage = 1;
        lerDadosExistentes();
      });

      // Lida com o clique no botão de página anterior
      document.getElementById('prevPageBtn').addEventListener('click', function() {
        if (currentPage > 1) {
          currentPage--;
          lerDadosExistentes();
        }
      });

      // Lida com o clique no botão de próxima página
      document.getElementById('nextPageBtn').addEventListener('click', function() {
        if (currentPage < totalPages) {
          currentPage++;
          lerDadosExistentes();
        }
      });

      // Lida com o clique no botão Aplicar Filtros
      document.getElementById('applyFiltersBtn').addEventListener('click', function() {
        hideMessage('readMessage');
        toggleSpinner('filterSpinner', true);

        const filterForm = document.getElementById('filterForm');
        const formData = new FormData(filterForm);
        currentFilters = {}; // Limpa filtros anteriores
        for (let [key, value] of formData.entries()) {
          if (value) { // Adiciona apenas filtros com valor
            currentFilters[key] = value;
          }
        }
        // Adicionando filtros de saída por intervalo de datas
        const saidaInicio = formData.get('saidaInicio');
        const saidaFim = formData.get('saidaFim');
        if (saidaInicio) currentFilters.saidaInicio = saidaInicio;
        if (saidaFim) currentFilters.saidaFim = saidaFim;

        currentPage = 1; // Ao aplicar filtros, sempre volte para a primeira página
        lerDadosExistentes();
      });

      // Lida com o clique no botão Limpar Filtros
      document.getElementById('clearFiltersBtn').addEventListener('click', function() {
        document.getElementById('filterForm').reset(); // Limpa os campos do formulário de filtro
        // Reset dos dropdowns de Assunto/Sub Assunto no filtro
        populateAssuntoDropdown(filterAssuntoSelect, 'Todos');
        populateSubAssuntoDropdown(filterSubAssuntoSelect, [], 'Todos', true);

        currentFilters = {}; // Limpa os filtros ativos
        currentPage = 1; // Volta para a primeira página
        lerDadosExistentes();
      });

      // Funções para abrir e fechar o modal
      openAddRecordModalBtn.addEventListener('click', function() {
        openRecordModal('add'); // Abre o modal no modo de adição
      });
      closeModalBtn.addEventListener('click', closeRecordModal);

      // Função para ler e exibir dados existentes na planilha com paginação e filtros
      function lerDadosExistentes() {
        hideMessage('readMessage'); // Esconde mensagens anteriores
        toggleSpinner('refreshSpinner', true); // Mostra o spinner de atualização
        toggleSpinner('filterSpinner', true); // Mostra o spinner de filtro (se aplicável)

        const dataTableBody = document.getElementById('dataTableBody');
        // Colspan ajustado para 15 (14 colunas de dados + 1 de Ações)
        dataTableBody.innerHTML = '<tr><td colspan="15" class="text-center py-4 text-gray-500">Carregando dados...</td></tr>'; // Mensagem de carregamento

        // Chama a função lerTodosOsDadosWeb no Apps Script com parâmetros de paginação e filtros
        google.script.run
          .withSuccessHandler(function(response) {
            toggleSpinner('refreshSpinner', false); // Esconde o spinner de atualização
            toggleSpinner('filterSpinner', false); // Esconde o spinner de filtro

            console.log('Dados recebidos do Apps Script:', response.data);
            console.log('Total de registros filtrados:', response.totalRecords);

            currentTableData = response.data; // Armazena os dados da tabela atual para edição
            totalRecords = response.totalRecords;
            totalPages = Math.ceil(totalRecords / pageSize);
            if (totalPages === 0) totalPages = 1;

            // renderiza as linhas da tabela
            renderTableRows();

            updatePaginationControls();
          })
          .withFailureHandler(function(error) {
            toggleSpinner('refreshSpinner', false);
            toggleSpinner('filterSpinner', false);
            showSpecificError(error);
            // Colspan ajustado para 15
            dataTableBody.innerHTML = '<tr><td colspan="15" class="text-center py-4 text-red-500">Erro ao carregar dados.</td></tr>';
            updatePaginationControls();
          })
          .lerTodosOsDadosWeb(currentPage, pageSize, currentFilters);
      }

      function loadAssuntoSubAssuntoMap() {
        google.script.run
          .withSuccessHandler(function(map) {
            assuntoSubAssuntoMap = map;
            console.log('Mapeamento Assunto/Sub Assunto carregado:', assuntoSubAssuntoMap);
            populateAssuntoDropdown(modalAssuntoSelect, 'Selecione');
            populateAssuntoDropdown(filterAssuntoSelect, 'Todos');
            populateSubAssuntoDropdown(modalSubAssuntoSelect, [], 'Selecione', true);
            populateSubAssuntoDropdown(filterSubAssuntoSelect, [], 'Todos', true);
          })
          .withFailureHandler(function(error) {
            showSpecificError(error);
          })
          .getAssuntoSubAssuntoMap();
      }

      // Função para exibir o e-mail do usuário
      function displayUserEmail() {
        google.script.run
          .withSuccessHandler(function(email) {
            userEmailDisplay.textContent = email;
          })
          .withFailureHandler(function(error) {
            showSpecificError(error);
            userEmailDisplay.textContent = 'Erro ao carregar e-mail.';
          })
          .getUserEmail();
      }

      // 1. Adicionar atributos de ordenação aos <th> da tabela:
      // Exemplo: <th class="sortable" data-field="status">Status</th>
      // ... para todos os cabeçalhos ...

      // 3. Adicionar variáveis de controle de ordenação:
      let currentSortField = null;
      let currentSortDirection = 'asc';

      // 4. Função para ordenar os dados:
      function sortTableData(field) {
        if (currentSortField === field) {
          currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          currentSortField = field;
          currentSortDirection = 'asc';
        }
        currentTableData.sort((a, b) => {
          const idx = sheetColumnIndexes[field];
          let valA = a[idx];
          let valB = b[idx];
          // Tenta converter para data se for campo de data
          if (field === 'entrada' || field === 'saida') {
            // Converte para formato YYYY-MM-DD para comparação correta de datas
            valA = valA.split('/').reverse().join('-');
            valB = valB.split('/').reverse().join('-');
          }
          if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
          if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
          return 0;
        });
        renderTableRows();
        updateSortIndicators();
      }

      // 5. Função para renderizar as linhas da tabela (extraída de lerDadosExistentes):
      function renderTableRows() {
        const dataTableBody = document.getElementById('dataTableBody');
        dataTableBody.innerHTML = '';
        if (currentTableData && currentTableData.length > 0) {
          currentTableData.forEach(function(linha, index) {
            const row = dataTableBody.insertRow();
            const actualSheetRowIndex = ((currentPage - 1) * pageSize) + index + 2;
            linha.forEach(function(celula) {
              const cell = row.insertCell();
              cell.textContent = celula;
            });
            // Adiciona a célula de ações com os botões Editar e Deletar
            const actionCell = row.insertCell();
            const editButton = document.createElement('button');
            editButton.textContent = 'Editar';
            editButton.classList.add('btn', 'btn-secondary', 'text-sm', 'px-3', 'py-1', 'mr-2');
            editButton.onclick = function() {
              openRecordModal('edit', actualSheetRowIndex, linha);
            };
            actionCell.appendChild(editButton);
            // Botão Deletar
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Deletar';
            deleteButton.classList.add('btn', 'btn-danger', 'text-sm', 'px-3', 'py-1');
            deleteButton.onclick = function() {
              if (confirm('Tem certeza que deseja deletar este registro?')) {
                google.script.run
                  .withSuccessHandler(function(response) {
                    if (response.sucesso) {
                      showMessage('readMessage', response.mensagem, 'success');
                      lerDadosExistentes();
                    } else {
                      showMessage('readMessage', response.mensagem, 'error');
                    }
                  })
                  .withFailureHandler(function(error) {
                    showSpecificError(error);
                  })
                  .deletarRegistroWeb(actualSheetRowIndex);
              }
            };
            actionCell.appendChild(deleteButton);
          });
        } else {
          dataTableBody.innerHTML = '<tr><td colspan="15" class="text-center py-4 text-gray-500">Nenhum dado encontrado na página atual ou com os filtros aplicados.</td></tr>';
        }
      }

      // 6. Atualizar indicadores visuais de ordenação:
      function updateSortIndicators() {
        document.querySelectorAll('th.sortable').forEach(th => {
          th.classList.remove('sorted-asc', 'sorted-desc');
          if (th.dataset.field === currentSortField) {
            th.classList.add(currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
          }
        });
      }

      document.addEventListener('DOMContentLoaded', function() {
        lerDadosExistentes();
        loadAssuntoSubAssuntoMap();
        displayUserEmail(); // Chama a função para exibir o e-mail do usuário

        // 7. Adicionar listeners aos cabeçalhos após DOMContentLoaded:
        document.querySelectorAll('th.sortable').forEach(th => {
          th.addEventListener('click', function() {
            sortTableData(th.dataset.field);
          });
        });
      });

      // 1. Função utilitária para exibir mensagens de erro específicas
      function showSpecificError(error) {
        let msg = 'Erro desconhecido.';
        if (typeof error === 'string') {
          msg = error;
        } else if (error && error.message) {
          msg = error.message;
        }
        if (msg.includes('Aba "Dados" não encontrada')) {
          showMessage('readMessage', 'Erro: A aba "Dados" não foi encontrada na planilha. Verifique se a aba existe ou peça ao administrador para criá-la.', 'error');
        } else if (msg.includes('Aba "Config Usuarios" não encontrada')) {
          showMessage('readMessage', 'Erro: A aba "Config Usuarios" não foi encontrada na planilha. Usuários não poderão acessar o sistema até que ela seja criada.', 'error');
        } else if (msg.includes('Aba "Config Assuntos" não encontrada')) {
          showMessage('readMessage', 'Erro: A aba "Config Assuntos" não foi encontrada na planilha. O cadastro de assuntos e subassuntos ficará indisponível.', 'error');
        } else if (msg.includes('Acesso negado')) {
          showMessage('readMessage', 'Acesso negado: seu e-mail não está autorizado a acessar este sistema.', 'error');
        } else if (msg.includes('Erro ao gravar dados')) {
          showMessage('modalResponseMessage', msg, 'error');
        } else if (msg.includes('Erro ao atualizar dados')) {
          showMessage('modalResponseMessage', msg, 'error');
        } else {
          showMessage('readMessage', 'Erro: ' + msg, 'error');
        }
      }
    </script>
  </body>
</html>