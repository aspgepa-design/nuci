<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>Gerenciador de Dados da Planilha</title>
    <!-- Inclui Tailwind CSS para estilização fácil e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Estilos personalizados para a fonte e o corpo */
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f0f4f8; /* Cor de fundo suave */
        color: #334155; /* Cor de texto padrão */
      }
      .container {
        max-width: 90%; /* Largura máxima para responsividade */
        margin: 2rem auto; /* Centraliza o container */
        padding: 1.5rem;
        background-color: #ffffff; /* Fundo branco para o conteúdo */
        border-radius: 0.75rem; /* Cantos arredondados */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Sombra suave */
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #1e293b;
      }
      .form-group input,
      .form-group textarea,
      .form-group select { /* Adicionado estilo para select */
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #cbd5e1;
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: border-color 0.2s;
      }
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus { /* Adicionado estilo de foco para select */
        outline: none;
        border-color: #3b82f6; /* Cor do foco */
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* Sombra do foco */
      }
      .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 700;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .btn-primary {
        background-color: #3b82f6; /* Azul primário */
        color: #ffffff;
      }
      .btn-primary:hover {
        background-color: #2563eb; /* Azul mais escuro no hover */
        transform: translateY(-1px); /* Pequeno efeito de elevação */
      }
      .btn-secondary {
        background-color: #64748b; /* Cinza secundário */
        color: #ffffff;
      }
      .btn-secondary:hover {
        background-color: #475569; /* Cinza mais escuro no hover */
        transform: translateY(-1px);
      }
      .btn-disabled {
        background-color: #e2e8f0; /* Cinza claro para desabilitado */
        color: #94a3b8; /* Cor de texto claro */
        cursor: not-allowed;
      }
      .message-box {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
      }
      .message-box.success {
        background-color: #d1fae5; /* Verde claro */
        color: #065f46; /* Verde escuro */
      }
      .message-box.error {
        background-color: #fee2e2; /* Vermelho claro */
        color: #991b1b; /* Vermelho escuro */
      }
      .message-box.info {
        background-color: #e0f2fe; /* Azul claro */
        color: #0c4a6e; /* Azul escuro */
      }
      /* Estilo para a tabela */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1.5rem;
      }
      th, td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e2e8f0; /* Borda inferior sutil */
        white-space: nowrap; /* Evita quebra de linha em células */
        overflow: hidden;
        text-overflow: ellipsis; /* Adiciona elipses se o conteúdo for muito longo */
      }
      th {
        background-color: #e2e8f0; /* Fundo para cabeçalhos */
        font-weight: 700;
        color: #1e293b;
        text-transform: uppercase;
        font-size: 0.875rem;
      }
      tr:hover {
        background-color: #f8fafc; /* Fundo leve no hover da linha */
      }
      .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #3b82f6;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-left: 0.5rem;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 1.5rem;
        gap: 1rem;
      }
      .pagination-controls button {
        @apply btn btn-secondary; /* Aplica estilos de botão secundário */
      }
      .pagination-controls button:disabled {
        @apply btn-disabled; /* Aplica estilo de desabilitado */
      }

      /* Estilos para o Modal (Popup) */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* Fundo semi-transparente */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50; /* Garante que fique por cima de tudo */
      }
      .modal-content {
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        max-width: 800px; /* Largura máxima do modal */
        width: 90%; /* Largura responsiva */
        max-height: 90vh; /* Altura máxima para rolagem interna */
        overflow-y: auto; /* Rolagem se o conteúdo for grande */
        position: relative;
      }
      .modal-close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #64748b;
      }
      .modal-close-btn:hover {
        color: #1e293b;
      }

      /* Estilos para ordenação de tabela */
      th.sortable { cursor: pointer; }
      th.sorted-asc::after { content: ' \25B2'; }
      th.sorted-desc::after { content: ' \25BC'; }
    </style>
  </head>
  <body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="container">
      <!-- Exibição do e-mail do usuário logado -->
      <div class="text-right text-gray-600 text-sm mb-4">
        Usuário logado: <span id="userEmailDisplay" class="font-semibold text-gray-800">Carregando...</span>
      </div>

      <h1 class="text-3xl font-extrabold text-center mb-6 text-gray-900">Gerenciador de Dados da Planilha</h1>

      <!-- Seção de Dashboard (Conteúdo placeholder por enquanto) -->
      <div class="mb-8 p-6 bg-purple-50 rounded-lg shadow-sm">
        <h2 class="text-xl font-bold mb-4 text-purple-800">Dashboard de Resumo</h2>
        <p class="text-gray-700">Aqui você pode adicionar gráficos, contadores ou resumos dos seus dados. Por exemplo:</p>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
          <div class="bg-purple-100 p-4 rounded-lg shadow-inner">
            <h3 class="text-lg font-semibold text-purple-700">Total de Registros</h3>
            <p id="dashboardTotalRecords" class="text-2xl font-bold text-purple-900">...</p>
          </div>
          <div class="bg-purple-100 p-4 rounded-lg shadow-inner">
            <h3 class="text-lg font-semibold text-purple-700">Status "Analisado"</h3>
            <p id="dashboardStatusAnalisado" class="text-2xl font-bold text-purple-900">...</p>
          </div>
          <div class="bg-purple-100 p-4 rounded-lg shadow-inner">
            <h3 class="text-lg font-semibold text-purple-700">Registros Recentes</h3>
            <p class="text-lg text-purple-900">Últimos 7 dias: <span id="dashboardRecentRecords">...</span></p>
          </div>
        </div>
      </div>

      <!-- Botão para abrir o Formulário de Inserção -->
      <div class="text-center mb-8">
        <button id="openAddRecordModalBtn" class="btn btn-primary text-xl px-8 py-3">
          + Adicionar Novo Registro
        </button>
      </div>

      <!-- Seção de Filtros -->
      <div class="mb-8 p-6 bg-yellow-50 rounded-lg shadow-sm">
        <h2 class="text-xl font-bold mb-4 text-yellow-800">Filtrar Dados</h2>
        <form id="filterForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="form-group">
              <label for="filterStatus">Status:</label>
              <input type="text" id="filterStatus" name="status" class="w-full">
            </div>
            <div class="form-group">
              <label for="filterSistema">Sistema:</label>
              <select id="filterSistema" name="sistema" class="w-full">
                <option value="">Todos</option>
                <option value="PAE 3.0">PAE 3.0</option>
                <option value="PAE 4.0">PAE 4.0</option>
                <option value="SAJ/ATTUS">SAJ/ATTUS</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filterNumPaejSaj">Núm.PAE/SAJ:</label>
              <input type="text" id="filterNumPaejSaj" name="numPaejSaj" class="w-full">
            </div>
            <div class="form-group">
              <label for="filterInteressado">Interessado:</label>
              <input type="text" id="filterInteressado" name="interessado" class="w-full">
            </div>
            <div class="form-group">
              <label for="filterSituacao">Situação:</label>
              <select id="filterSituacao" name="situacao" class="w-full">
                <option value="">Todos</option>
                <option value="CONFORME">CONFORME</option>
                <option value="CONFORME PARCIAL">CONFORME PARCIAL</option>
                <option value="INCONFORME">INCONFORME</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filterAssimetria">Assimetria:</label>
              <select id="filterAssimetria" name="assimetria" class="w-full">
                <option value="">Todos</option>
                <option value="DESACORDO LEGAL">DESACORDO LEGAL</option>
                <option value="FALTA DE DOCUMENTO">FALTA DE DOCUMENTO</option>
                <option value="PRAZO">PRAZO</option>
                <option value="ESCLARECIMENTO">ESCLARECIMENTO</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filterUgOrigem">UG Origem:</label>
              <input type="text" id="filterUgOrigem" name="ugOrigem" class="w-full">
            </div>
            <div class="form-group">
              <label for="filterAssunto">Assunto:</label>
              <select id="filterAssunto" name="assunto" class="w-full">
                <option value="">Todos</option>
                <!-- Opções de Assunto serão carregadas via JS -->
              </select>
            </div>
            <div class="form-group">
              <label for="filterSubAssunto">Sub Assunto:</label>
              <select id="filterSubAssunto" name="subAssunto" class="w-full" disabled>
                <option value="">Todos</option>
                <!-- Opções de Sub Assunto serão carregadas via JS -->
              </select>
            </div>
            <div class="form-group">
              <label for="filterAciResponsavel">ACI Responsável:</label>
              <input type="text" id="filterAciResponsavel" name="aciResponsavel" class="w-full">
            </div>
            <div class="form-group">
              <label for="filterDestino">Destino:</label>
              <input type="text" id="filterDestino" name="destino" class="w-full">
            </div>
            <div class="form-group">
              <label for="filterSaida">Saída:</label>
              <input type="date" id="filterSaida" name="saida" class="w-full">
            </div>
          </div>
          <button type="button" id="applyFiltersBtn" class="btn btn-primary w-full sm:w-auto mt-4">
            Aplicar Filtros
            <span id="filterSpinner" class="loading-spinner hidden"></span>
          </button>
          <button type="button" id="clearFiltersBtn" class="btn btn-secondary w-full sm:w-auto mt-4">
            Limpar Filtros
          </button>
        </form>
      </div>

      <!-- Seção de Leitura de Dados -->
      <div class="p-6 bg-green-50 rounded-lg shadow-sm">
        <h2 class="text-xl font-bold mb-4 text-green-800">Dados Existentes na Planilha</h2>
        <button id="refreshDataBtn" class="btn btn-secondary mb-4 w-full sm:w-auto">
          Atualizar Dados
          <span id="refreshSpinner" class="loading-spinner hidden"></span>
        </button>
        <div id="dataContainer" class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead>
              <tr>
                <th class="px-6 py-3 sortable" data-field="status">Status</th>
                <th class="px-6 py-3 sortable" data-field="sistema">Sistema</th>
                <th class="px-6 py-3 sortable" data-field="numPaejSaj">Núm.PAE/SAJ</th>
                <th class="px-6 py-3 sortable" data-field="interessado">Interessado</th>
                <th class="px-6 py-3 sortable" data-field="entrada">Entrada</th>
                <th class="px-6 py-3 sortable" data-field="situacao">Situação</th>
                <th class="px-6 py-3 sortable" data-field="assimetria">Assimetria</th>
                <th class="px-6 py-3">Observação</th>
                <th class="px-6 py-3 sortable" data-field="ugOrigem">UG Origem</th>
                <th class="px-6 py-3 sortable" data-field="assunto">Assunto</th>
                <th class="px-6 py-3 sortable" data-field="subAssunto">Sub Assunto</th>
                <th class="px-6 py-3 sortable" data-field="aciResponsavel">ACI Responsável</th>
                <th class="px-6 py-3 sortable" data-field="destino">Destino</th>
                <th class="px-6 py-3 sortable" data-field="saida">Saída</th>
                <th class="px-6 py-3">Ações</th>
              </tr>
            </thead>
            <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
              <!-- Dados serão carregados aqui -->
              <tr>
                <td colspan="15" class="text-center py-4 text-gray-500">Nenhum dado carregado.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- Controles de Paginação -->
        <div class="pagination-controls">
          <button id="prevPageBtn" disabled>Anterior</button>
          <span id="pageInfo" class="text-gray-700 font-semibold">Página 1 de 1</span>
          <button id="nextPageBtn" disabled>Próximo</button>
        </div>
        <div id="readMessage" class="message-box hidden mt-4"></div>
      </div>
    </div>

    <!-- Modal para Inserção/Edição de Dados -->
    <div id="recordModal" class="modal-overlay hidden">
      <div class="modal-content">
        <button id="closeModalBtn" class="modal-close-btn">&times;</button>
        <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-blue-800">Adicionar Novo Registro</h2>
        <form id="recordFormModal" class="space-y-4">
          <!-- Campo oculto para armazenar o índice da linha sendo editada -->
          <input type="hidden" id="recordRowIndex" name="rowIndex">

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="form-group">
              <label for="modalStatus">Status:</label>
              <input type="text" id="modalStatus" name="status" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalSistema">Sistema:</label>
              <select id="modalSistema" name="sistema" class="w-full">
                <option value="">Selecione</option>
                <option value="PAE 3.0">PAE 3.0</option>
                <option value="PAE 4.0">PAE 4.0</option>
                <option value="SAJ/ATTUS">SAJ/ATTUS</option>
              </select>
            </div>
            <div class="form-group">
              <label for="modalNumPaejSaj">Núm.PAE/SAJ:</label>
              <input type="text" id="modalNumPaejSaj" name="numPaejSaj" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalInteressado">Interessado:</label>
              <input type="text" id="modalInteressado" name="interessado" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalEntrada">Entrada:</label>
              <input type="date" id="modalEntrada" name="entrada" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalSituacao">Situação:</label>
              <select id="modalSituacao" name="situacao" class="w-full">
                <option value="">Selecione</option>
                <option value="CONFORME">CONFORME</option>
                <option value="CONFORME PARCIAL">CONFORME PARCIAL</option>
                <option value="INCONFORME">INCONFORME</option>
              </select>
            </div>
            <div class="form-group">
              <label for="modalAssimetria">Assimetria:</label>
              <select id="modalAssimetria" name="assimetria" class="w-full">
                <option value="">Selecione</option>
                <option value="DESACORDO LEGAL">DESACORDO LEGAL</option>
                <option value="FALTA DE DOCUMENTO">FALTA DE DOCUMENTO</option>
                <option value="PRAZO">PRAZO</option>
                <option value="ESCLARECIMENTO">ESCLARECIMENTO</option>
              </select>
            </div>
            <div class="form-group">
              <label for="modalObservacao">Observação:</label>
              <textarea id="modalObservacao" name="observacao" rows="2" class="w-full"></textarea>
            </div>
            <div class="form-group">
              <label for="modalUgOrigem">UG Origem:</label>
              <input type="text" id="modalUgOrigem" name="ugOrigem" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalAssunto">Assunto:</label>
              <select id="modalAssunto" name="assunto" class="w-full">
                <option value="">Selecione</option>
                <!-- Opções de Assunto serão carregadas via JS -->
              </select>
            </div>
            <div class="form-group">
              <label for="modalSubAssunto">Sub Assunto:</label>
              <select id="modalSubAssunto" name="subAssunto" class="w-full" disabled>
                <option value="">Selecione</option>
                <!-- Opções de Sub Assunto serão carregadas via JS -->
              </select>
            </div>
            <div class="form-group">
              <label for="modalAciResponsavel">ACI Responsável:</label>
              <input type="text" id="modalAciResponsavel" name="aciResponsavel" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalDestino">Destino:</label>
              <input type="text" id="modalDestino" name="destino" class="w-full">
            </div>
            <div class="form-group">
              <label for="modalSaida">Saída:</label>
              <input type="date" id="modalSaida" name="saida" class="w-full">
            </div>
          </div>
          <button type="submit" id="modalSubmitBtn" class="btn btn-primary w-full sm:w-auto mt-4">
            Gravar Registro
            <span id="modalLoadingSpinner" class="loading-spinner hidden"></span>
          </button>
          <div id="modalResponseMessage" class="message-box hidden"></div>
        </form>
      </div>
    </div>

    <script>
      // Variáveis de Paginação
      let currentPage = 1;
      const pageSize = 20; // Defina o número de registros por página
      let totalRecords = 0;
      let totalPages = 1;
      let currentFilters = {}; // Objeto para armazenar os filtros ativos

      // Variáveis do Dashboard
      let allDataForDashboard = []; // Para armazenar todos os dados brutos para o dashboard
      let currentTableData = []; // Para armazenar os dados da tabela atual para edição

      // Referências aos elementos do modal
      const recordModal = document.getElementById('recordModal');
      const openAddRecordModalBtn = document.getElementById('openAddRecordModalBtn');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const recordFormModal = document.getElementById('recordFormModal');
      const modalLoadingSpinner = document.getElementById('modalLoadingSpinner');
      const modalResponseMessage = document.getElementById('modalResponseMessage');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubmitBtn = document.getElementById('modalSubmitBtn');

      // Referência ao campo oculto para o índice da linha
      const recordRowIndex = document.getElementById('recordRowIndex');

      // Referências aos campos Sistema e Num. PAEJ S.A.J. (para máscara)
      const modalSistemaSelect = document.getElementById('modalSistema');
      const modalNumPaejSajInput = document.getElementById('modalNumPaejSaj');
      const sistemaSelectFilter = document.getElementById('filterSistema');

      // Referências para os campos Situação e Assimetria no modal
      const modalSituacaoSelect = document.getElementById('modalSituacao');
      const modalAssimetriaSelect = document.getElementById('modalAssimetria');

      // Novas referências para os campos Assunto e Sub Assunto (modal e filtro)
      const modalAssuntoSelect = document.getElementById('modalAssunto');
      const modalSubAssuntoSelect = document.getElementById('modalSubAssunto');
      const filterAssuntoSelect = document.getElementById('filterAssunto');
      const filterSubAssuntoSelect = document.getElementById('filterSubAssunto');

      // Referências para os novos campos ACI Responsável, Destino e Saída (modal e filtro)
      const modalAciResponsavelInput = document.getElementById('modalAciResponsavel');
      const modalDestinoInput = document.getElementById('modalDestino');
      const modalSaidaInput = document.getElementById('modalSaida'); // Input de data já existia, mas referenciando explicitamente

      const filterAciResponsavelInput = document.getElementById('filterAciResponsavel');
      const filterDestinoInput = document.getElementById('filterDestino');
      const filterSaidaInput = document.getElementById('filterSaida');

      // Referência para exibir o e-mail do usuário
      const userEmailDisplay = document.getElementById('userEmailDisplay');


      let assuntoSubAssuntoMap = {}; // Variável para armazenar o mapeamento Assunto -> Sub Assuntos

      // Nomes dos campos do formulário para fácil iteração (total de 14 campos agora)
      const formFields = [
        'status', 'sistema', 'numPaejSaj', 'interessado', 'entrada', 'situacao',
        'assimetria', 'observacao', 'ugOrigem', 'assunto', 'subAssunto',
        'aciResponsavel', 'destino', 'saida'
      ];

      // Mapeamento dos nomes dos campos do formulário para os índices das colunas na planilha (base 0 para JS)
      // ATENÇÃO: ESTE MAPEAMENTO DEVE CORRESPONDER À ORDEM DAS COLUNAS NA SUA PLANILHA GOOGLE
      const sheetColumnIndexes = {
        status: 0,
        sistema: 1,
        numPaejSaj: 2,
        interessado: 3,
        entrada: 4,
        situacao: 5,
        assimetria: 6,
        observacao: 7,
        ugOrigem: 8,
        assunto: 9,
        subAssunto: 10,
        aciResponsavel: 11,
        destino: 12,
        saida: 13
      };


      // Função para exibir mensagens de status
      function showMessage(elementId, message, type) {
        const messageBox = document.getElementById(elementId);
        messageBox.textContent = message;
        messageBox.className = `message-box ${type}`; // Adiciona classes de estilo dinamicamente
        messageBox.classList.remove('hidden');
      }

      // Função para esconder mensagens de status
      function hideMessage(elementId) {
        document.getElementById(elementId).classList.add('hidden');
      }

      // Função para mostrar ou esconder o spinner de carregamento
      function toggleSpinner(spinnerId, show) {
        document.getElementById(spinnerId).classList.toggle('hidden', !show);
      }

      // Atualiza os controles de paginação (botões e texto)
      function updatePaginationControls() {
        document.getElementById('pageInfo').textContent = `Página ${currentPage} de ${totalPages}`;
        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalRecords === 0;
      }

      // Funções para abrir e fechar o modal (reutilizado para adicionar/editar)
      function openRecordModal(mode, rowIndex = -1, rowData = null) {
        recordModal.classList.remove('hidden');
        hideMessage('modalResponseMessage'); // Esconde mensagens anteriores

        if (mode === 'add') {
          recordFormModal.reset();
          modalTitle.textContent = 'Adicionar Novo Registro';
          modalSubmitBtn.textContent = 'Gravar Registro';
          recordRowIndex.value = '';
          modalNumPaejSajInput.value = '';
          modalNumPaejSajInput.placeholder = 'Selecione um Sistema para a máscara';
          modalSistemaSelect.value = '';
          updateAssimetriaFieldState();
          populateAssuntoDropdown(modalAssuntoSelect, 'Selecione');
          populateSubAssuntoDropdown(modalSubAssuntoSelect, [], 'Selecione', true);
        } else if (mode === 'edit' && rowData) {
          modalTitle.textContent = 'Editar Registro';
          modalSubmitBtn.textContent = 'Atualizar Registro';
          recordRowIndex.value = rowIndex;
          // Preencher o formulário com os dados da linha
          formFields.forEach(field => {
            let inputElement = document.getElementById('modal' + field.charAt(0).toUpperCase() + field.slice(1));
            if (field === 'numPaejSaj') inputElement = document.getElementById('modalNumPaejSaj');
            if (field === 'aciResponsavel') inputElement = document.getElementById('modalAciResponsavel');
            if (inputElement) {
              const value = rowData[sheetColumnIndexes[field]];
              if (inputElement.type === 'date') {
                if (value && typeof value === 'string' && value.match(/^[0-9]{4}-[0-9]{2}-[0-9]{2}T/)) {
                  inputElement.value = value.split('T')[0];
                } else {
                  inputElement.value = '';
                }
              } else if (inputElement.tagName === 'SELECT') {
                // Para selects, defina o valor diretamente
                inputElement.value = value;
                // Se for Assunto, dispare a atualização do Sub Assunto
                if (field === 'assunto') {
                  populateAssuntoDropdown(modalAssuntoSelect, 'Selecione');
                  modalAssuntoSelect.value = value;
                  updateSubAssuntoDropdown(modalAssuntoSelect, modalSubAssuntoSelect);
                  modalSubAssuntoSelect.value = rowData[sheetColumnIndexes['subAssunto']];
                }
                // Se for Situação, dispare a atualização da Assimetria
                if (field === 'situacao') {
                  updateAssimetriaFieldState();
                }
                // Se for Sistema, dispare a atualização da máscara do PAEJ SAJ
                if (field === 'sistema') {
                  updatePaejMask();
                }
              } else {
                inputElement.value = value;
              }
            }
          });
          // Se o sistema já estiver selecionado na edição, aplica a máscara
          if (modalSistemaSelect.value) {
            updatePaejMask();
            applyMask(modalNumPaejSajInput, masks[modalSistemaSelect.value]);
          }
        }
        recordModal.classList.remove('hidden');
      }

      function closeRecordModal() {
        recordModal.classList.add('hidden');
      }

      // Lógica de Máscara de Entrada para Num. PAEJ S.A.J.
      const masks = {
        'PAE 3.0': '2025/00000000',
        'PAE 4.0': 'E-2025/00000000',
        'SAJ/ATTUS': '2020.01.00000000000'
      };

      function applyMask(inputElement, mask) {
        if (!inputElement || !mask) return;

        inputElement.placeholder = mask; // Exibe a máscara como placeholder
        let current = inputElement.value;
        let formatted = '';
        let maskCharIndex = 0;
        let valueCharIndex = 0;

        while (maskCharIndex < mask.length && valueCharIndex < current.length) {
          if (mask[maskCharIndex] === '0') { // Caractere de preenchimento (número)
            if (/\d/.test(current[valueCharIndex])) {
              formatted += current[valueCharIndex];
              valueCharIndex++;
            }
            maskCharIndex++;
          } else { // Caractere literal da máscara
            formatted += mask[maskCharIndex];
            if (mask[maskCharIndex] === current[valueCharIndex]) {
              valueCharIndex++; // Consome o caractere da entrada se corresponder à máscara
            }
            maskCharIndex++;
          }
        }
        inputElement.value = formatted;
      }

      function updatePaejMask() {
        const selectedSystem = modalSistemaSelect.value;
        const mask = masks[selectedSystem];
        if (mask) {
          modalNumPaejSajInput.placeholder = mask;
        } else {
          modalNumPaejSajInput.value = '';
          modalNumPaejSajInput.placeholder = 'Selecione um Sistema para a máscara';
        }
      }

      // Lógica de dependência entre Situação e Assimetria
      function updateAssimetriaFieldState() {
        const situacaoValue = modalSituacaoSelect.value;
        if (situacaoValue === 'CONFORME') {
          modalAssimetriaSelect.value = ''; // Limpa o valor
          modalAssimetriaSelect.disabled = true; // Desabilita o campo
          modalAssimetriaSelect.classList.add('bg-gray-200'); // Adiciona estilo visual de desabilitado
        } else {
          modalAssimetriaSelect.disabled = false; // Habilita o campo
          modalAssimetriaSelect.classList.remove('bg-gray-200'); // Remove estilo visual de desabilitado
        }
      }

      // Lógica de dependência entre Assunto e Sub Assunto
      function populateAssuntoDropdown(dropdownElement, defaultOptionText = 'Selecione') {
        dropdownElement.innerHTML = ''; // Limpa opções existentes
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = defaultOptionText;
        dropdownElement.appendChild(defaultOption);

        const assuntos = Object.keys(assuntoSubAssuntoMap).sort(); // Obtém e ordena os assuntos
        assuntos.forEach(assunto => {
          const option = document.createElement('option');
          option.value = assunto;
          option.textContent = assunto;
          dropdownElement.appendChild(option);
        });
      }

      function populateSubAssuntoDropdown(dropdownElement, subAssuntos, defaultOptionText = 'Selecione', disable = false) {
        dropdownElement.innerHTML = ''; // Limpa opções existentes
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = defaultOptionText;
        dropdownElement.appendChild(defaultOption);

        subAssuntos.sort().forEach(subAssunto => { // Adiciona e ordena sub assuntos
          const option = document.createElement('option');
          option.value = subAssunto;
          option.textContent = subAssunto;
          dropdownElement.appendChild(option);
        });

        dropdownElement.disabled = disable;
        dropdownElement.classList.toggle('bg-gray-200', disable);
      }

      function updateSubAssuntoDropdown(assuntoSelectElement, subAssuntoSelectElement) {
        const selectedAssunto = assuntoSelectElement.value;
        const subAssuntos = assuntoSubAssuntoMap[selectedAssunto] || [];
        
        if (selectedAssunto === '') {
            populateSubAssuntoDropdown(subAssuntoSelectElement, [], 'Selecione', true); // Limpa e desabilita
        } else {
            populateSubAssuntoDropdown(subAssuntoSelectElement, subAssuntos, 'Selecione', false); // Habilita
        }
      }


      // --- EVENT LISTENERS ---

      // Sistema e Num. PAEJ S.A.J. (Modal)
      modalSistemaSelect.addEventListener('change', updatePaejMask);
      modalNumPaejSajInput.addEventListener('input', function() {
        const selectedSystem = modalSistemaSelect.value;
        const mask = masks[selectedSystem];
        if (mask) {
          applyMask(this, mask);
        }
      });

      // Situação e Assimetria (Modal)
      modalSituacaoSelect.addEventListener('change', updateAssimetriaFieldState);

      // Assunto e Sub Assunto (Modal)
      modalAssuntoSelect.addEventListener('change', function() {
        updateSubAssuntoDropdown(modalAssuntoSelect, modalSubAssuntoSelect);
      });

      // Assunto e Sub Assunto (Filtro)
      filterAssuntoSelect.addEventListener('change', function() {
        updateSubAssuntoDropdown(filterAssuntoSelect, filterSubAssuntoSelect);
      });


      // Lida com o envio do formulário dentro do modal para gravar/atualizar dados
      recordFormModal.addEventListener('submit', function(e) {
        e.preventDefault(); // Impede o envio padrão do formulário
        hideMessage('modalResponseMessage'); // Esconde mensagens anteriores
        toggleSpinner('modalLoadingSpinner', true); // Mostra o spinner

        const formData = new FormData(this);
        const data = {};
        for (let [key, value] of formData.entries()) {
          data[key] = value;
        }

        const rowIndexToEdit = recordRowIndex.value;

        if (rowIndexToEdit) { // Modo de Edição
          google.script.run
            .withSuccessHandler(function(response) {
              toggleSpinner('modalLoadingSpinner', false); // Esconde o spinner
              if (response.sucesso) {
                showMessage('modalResponseMessage', response.mensagem, 'success');
                setTimeout(() => {
                  closeRecordModal();
                  lerDadosExistentes(); // Recarrega a tabela atualizada
                  lerDadosDashboard(); // Atualiza o dashboard
                }, 1500);
              } else {
                showMessage('modalResponseMessage', response.mensagem, 'error');
              }
            })
            .withFailureHandler(function(error) {
              toggleSpinner('modalLoadingSpinner', false); // Esconde o spinner
              showSpecificError(error);
            })
            .atualizarDadosWeb(rowIndexToEdit, data);
        } else { // Modo de Adição
          google.script.run
            .withSuccessHandler(function(response) {
              toggleSpinner('modalLoadingSpinner', false); // Esconde o spinner
              if (response.sucesso) {
                showMessage('modalResponseMessage', response.mensagem, 'success');
                setTimeout(() => {
                  closeRecordModal();
                  currentPage = 1; // Volta para a primeira página para ver o novo registro
                  lerDadosExistentes();
                  lerDadosDashboard(); // Atualiza também o dashboard
                }, 1500);
              } else {
                showMessage('modalResponseMessage', response.mensagem, 'error');
              }
            })
            .withFailureHandler(function(error) {
              toggleSpinner('modalLoadingSpinner', false); // Esconde o spinner
              showSpecificError(error);
            })
            .gravarDadosWeb(data);
        }
      });

      // Lida com o clique no botão de atualizar dados
      document.getElementById('refreshDataBtn').addEventListener('click', function() {
        currentPage = 1;
        lerDadosExistentes();
        lerDadosDashboard(); // Atualiza também o dashboard
      });

      // Lida com o clique no botão de página anterior
      document.getElementById('prevPageBtn').addEventListener('click', function() {
        if (currentPage > 1) {
          currentPage--;
          lerDadosExistentes();
        }
      });

      // Lida com o clique no botão de próxima página
      document.getElementById('nextPageBtn').addEventListener('click', function() {
        if (currentPage < totalPages) {
          currentPage++;
          lerDadosExistentes();
        }
      });

      // Lida com o clique no botão Aplicar Filtros
      document.getElementById('applyFiltersBtn').addEventListener('click', function() {
        hideMessage('readMessage');
        toggleSpinner('filterSpinner', true);

        const filterForm = document.getElementById('filterForm');
        const formData = new FormData(filterForm);
        currentFilters = {}; // Limpa filtros anteriores
        for (let [key, value] of formData.entries()) {
          if (value) { // Adiciona apenas filtros com valor
            currentFilters[key] = value;
          }
        }
        currentPage = 1; // Ao aplicar filtros, sempre volte para a primeira página
        lerDadosExistentes();
      });

      // Lida com o clique no botão Limpar Filtros
      document.getElementById('clearFiltersBtn').addEventListener('click', function() {
        document.getElementById('filterForm').reset(); // Limpa os campos do formulário de filtro
        // Reset dos dropdowns de Assunto/Sub Assunto no filtro
        populateAssuntoDropdown(filterAssuntoSelect, 'Todos');
        populateSubAssuntoDropdown(filterSubAssuntoSelect, [], 'Todos', true);

        currentFilters = {}; // Limpa os filtros ativos
        currentPage = 1; // Volta para a primeira página
        lerDadosExistentes();
      });

      // Funções para abrir e fechar o modal
      openAddRecordModalBtn.addEventListener('click', function() {
        openRecordModal('add'); // Abre o modal no modo de adição
      });
      closeModalBtn.addEventListener('click', closeRecordModal);

      // Função para ler e exibir dados existentes na planilha com paginação e filtros
      function lerDadosExistentes() {
        hideMessage('readMessage'); // Esconde mensagens anteriores
        toggleSpinner('refreshSpinner', true); // Mostra o spinner de atualização
        toggleSpinner('filterSpinner', true); // Mostra o spinner de filtro (se aplicável)

        const dataTableBody = document.getElementById('dataTableBody');
        // Colspan ajustado para 15 (14 colunas de dados + 1 de Ações)
        dataTableBody.innerHTML = '<tr><td colspan="15" class="text-center py-4 text-gray-500">Carregando dados...</td></tr>'; // Mensagem de carregamento

        // Chama a função lerTodosOsDadosWeb no Apps Script com parâmetros de paginação e filtros
        google.script.run
          .withSuccessHandler(function(response) {
            toggleSpinner('refreshSpinner', false); // Esconde o spinner de atualização
            toggleSpinner('filterSpinner', false); // Esconde o spinner de filtro

            console.log('Dados recebidos do Apps Script:', response.data);
            console.log('Total de registros filtrados:', response.totalRecords);

            currentTableData = response.data; // Armazena os dados da tabela atual para edição
            totalRecords = response.totalRecords;
            totalPages = Math.ceil(totalRecords / pageSize);
            if (totalPages === 0) totalPages = 1;

            // renderiza as linhas da tabela
            renderTableRows();

            updatePaginationControls();
          })
          .withFailureHandler(function(error) {
            toggleSpinner('refreshSpinner', false);
            toggleSpinner('filterSpinner', false);
            showSpecificError(error);
            // Colspan ajustado para 15
            dataTableBody.innerHTML = '<tr><td colspan="15" class="text-center py-4 text-red-500">Erro ao carregar dados.</td></tr>';
            updatePaginationControls();
          })
          .lerTodosOsDadosWeb(currentPage, pageSize, currentFilters);
      }

      // Função para buscar todos os dados (sem paginação/filtros) para o dashboard
      function lerDadosDashboard() {
        google.script.run
          .withSuccessHandler(function(response) {
            allDataForDashboard = response.data;
            console.log('Dados totais para dashboard:', allDataForDashboard.length);
            updateDashboard();
          })
          .withFailureHandler(function(error) {
            showSpecificError(error);
            document.getElementById('dashboardTotalRecords').textContent = 'Erro';
            document.getElementById('dashboardStatusAnalisado').textContent = 'Erro';
            document.getElementById('dashboardRecentRecords').textContent = 'Erro';
          })
          .lerTodosOsDadosWebSemPaginacao();
      }

      // Função para atualizar os elementos do dashboard
      function updateDashboard() {
        // Mapeamento dos índices das colunas para os nomes dos campos (para o dashboard)
        // ATENÇÃO: Verifique se esses índices correspondem à sua planilha atual
        const columnIndexMap = {
            status: 0,
            sistema: 1,
            numPaejSaj: 2,
            interessado: 3,
            entrada: 4,
            situacao: 5,
            assimetria: 6,
            observacao: 7,
            ugOrigem: 8,
            assunto: 9,
            subAssunto: 10,
            aciResponsavel: 11,
            destino: 12,
            saida: 13
        };

        document.getElementById('dashboardTotalRecords').textContent = allDataForDashboard.length;

        const statusAnalisadoCount = allDataForDashboard.filter(row =>
            row[columnIndexMap.status] && row[columnIndexMap.status].toString().toLowerCase() === 'analisado'
        ).length;
        document.getElementById('dashboardStatusAnalisado').textContent = statusAnalisadoCount;

        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        sevenDaysAgo.setHours(0, 0, 0, 0);

        const recentRecordsCount = allDataForDashboard.filter(row => {
            const entradaDateString = row[columnIndexMap.entrada];
            if (typeof entradaDateString === 'string' && entradaDateString.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d{3})?Z$/)) {
                try {
                    const entryDate = new Date(entradaDateString);
                    entryDate.setHours(0, 0, 0, 0);
                    return entryDate >= sevenDaysAgo;
                } catch (e) {
                    return false;
                }
            }
            return false;
        }).length;
        document.getElementById('dashboardRecentRecords').textContent = recentRecordsCount;
      }

      function loadAssuntoSubAssuntoMap() {
        google.script.run
          .withSuccessHandler(function(map) {
            assuntoSubAssuntoMap = map;
            console.log('Mapeamento Assunto/Sub Assunto carregado:', assuntoSubAssuntoMap);
            populateAssuntoDropdown(modalAssuntoSelect, 'Selecione');
            populateAssuntoDropdown(filterAssuntoSelect, 'Todos');
            populateSubAssuntoDropdown(modalSubAssuntoSelect, [], 'Selecione', true);
            populateSubAssuntoDropdown(filterSubAssuntoSelect, [], 'Todos', true);
          })
          .withFailureHandler(function(error) {
            showSpecificError(error);
          })
          .getAssuntoSubAssuntoMap();
      }

      // Função para exibir o e-mail do usuário
      function displayUserEmail() {
        google.script.run
          .withSuccessHandler(function(email) {
            userEmailDisplay.textContent = email;
          })
          .withFailureHandler(function(error) {
            showSpecificError(error);
            userEmailDisplay.textContent = 'Erro ao carregar e-mail.';
          })
          .getUserEmail();
      }

      // 1. Adicionar atributos de ordenação aos <th> da tabela:
      // Exemplo: <th class="sortable" data-field="status">Status</th>
      // ... para todos os cabeçalhos ...

      // 3. Adicionar variáveis de controle de ordenação:
      let currentSortField = null;
      let currentSortDirection = 'asc';

      // 4. Função para ordenar os dados:
      function sortTableData(field) {
        if (currentSortField === field) {
          currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          currentSortField = field;
          currentSortDirection = 'asc';
        }
        currentTableData.sort((a, b) => {
          const idx = sheetColumnIndexes[field];
          let valA = a[idx];
          let valB = b[idx];
          // Tenta converter para data se for campo de data
          if (field === 'entrada' || field === 'saida') {
            valA = valA.split('/').reverse().join('-');
            valB = valB.split('/').reverse().join('-');
          }
          if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
          if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
          return 0;
        });
        renderTableRows();
        updateSortIndicators();
      }

      // 5. Função para renderizar as linhas da tabela (extraída de lerDadosExistentes):
      function renderTableRows() {
        const dataTableBody = document.getElementById('dataTableBody');
        dataTableBody.innerHTML = '';
        if (currentTableData && currentTableData.length > 0) {
          currentTableData.forEach(function(linha, index) {
            const row = dataTableBody.insertRow();
            const actualSheetRowIndex = ((currentPage - 1) * pageSize) + index + 2;
            linha.forEach(function(celula) {
              const cell = row.insertCell();
              cell.textContent = celula;
            });
            // Adiciona a célula de ações com os botões Editar e Deletar
            const actionCell = row.insertCell();
            const editButton = document.createElement('button');
            editButton.textContent = 'Editar';
            editButton.classList.add('btn', 'btn-secondary', 'text-sm', 'px-3', 'py-1', 'mr-2');
            editButton.onclick = function() {
              openRecordModal('edit', actualSheetRowIndex, linha);
            };
            actionCell.appendChild(editButton);
            // Botão Deletar
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Deletar';
            deleteButton.classList.add('btn', 'btn-danger', 'text-sm', 'px-3', 'py-1');
            deleteButton.onclick = function() {
              if (confirm('Tem certeza que deseja deletar este registro?')) {
                google.script.run
                  .withSuccessHandler(function(response) {
                    if (response.sucesso) {
                      showMessage('readMessage', response.mensagem, 'success');
                      lerDadosExistentes();
                      lerDadosDashboard();
                    } else {
                      showMessage('readMessage', response.mensagem, 'error');
                    }
                  })
                  .withFailureHandler(function(error) {
                    showSpecificError(error);
                  })
                  .deletarRegistroWeb(actualSheetRowIndex);
              }
            };
            actionCell.appendChild(deleteButton);
          });
        } else {
          dataTableBody.innerHTML = '<tr><td colspan="15" class="text-center py-4 text-gray-500">Nenhum dado encontrado na página atual ou com os filtros aplicados.</td></tr>';
        }
      }

      // 6. Atualizar indicadores visuais de ordenação:
      function updateSortIndicators() {
        document.querySelectorAll('th.sortable').forEach(th => {
          th.classList.remove('sorted-asc', 'sorted-desc');
          if (th.dataset.field === currentSortField) {
            th.classList.add(currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
          }
        });
      }

      document.addEventListener('DOMContentLoaded', function() {
        lerDadosExistentes();
        lerDadosDashboard();
        loadAssuntoSubAssuntoMap();
        displayUserEmail(); // Chama a função para exibir o e-mail do usuário

        // 7. Adicionar listeners aos cabeçalhos após DOMContentLoaded:
        document.querySelectorAll('th.sortable').forEach(th => {
          th.addEventListener('click', function() {
            sortTableData(th.dataset.field);
          });
        });
      });

      // 1. Função utilitária para exibir mensagens de erro específicas
      function showSpecificError(error) {
        let msg = 'Erro desconhecido.';
        if (typeof error === 'string') {
          msg = error;
        } else if (error && error.message) {
          msg = error.message;
        }
        if (msg.includes('Aba "Dados" não encontrada')) {
          showMessage('readMessage', 'Erro: A aba "Dados" não foi encontrada na planilha. Verifique se a aba existe ou peça ao administrador para criá-la.', 'error');
        } else if (msg.includes('Aba "Config Usuarios" não encontrada')) {
          showMessage('readMessage', 'Erro: A aba "Config Usuarios" não foi encontrada na planilha. Usuários não poderão acessar o sistema até que ela seja criada.', 'error');
        } else if (msg.includes('Aba "Config Assuntos" não encontrada')) {
          showMessage('readMessage', 'Erro: A aba "Config Assuntos" não foi encontrada na planilha. O cadastro de assuntos e subassuntos ficará indisponível.', 'error');
        } else if (msg.includes('Acesso negado')) {
          showMessage('readMessage', 'Acesso negado: seu e-mail não está autorizado a acessar este sistema.', 'error');
        } else if (msg.includes('Erro ao gravar dados')) {
          showMessage('modalResponseMessage', msg, 'error');
        } else if (msg.includes('Erro ao atualizar dados')) {
          showMessage('modalResponseMessage', msg, 'error');
        } else {
          showMessage('readMessage', 'Erro: ' + msg, 'error');
        }
      }
    </script>
  </body>
</html>
